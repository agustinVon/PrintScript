/*
 * This Scala source file was generated by the Gradle 'init' task.
 */
package PrintScript
import interpreter.{DisplayMethod, InputMethod, InterpreterImpl, PrintScriptInput, PrintScriptPrinter}
import lexer.LexerImpl
import parser.ParserImpl
import parser.exceptions.{ExpectedEndOfLineException, ExpressionExpectedException}
import sources.FileProgramSource

class JavaApp {
  def interpret(
      source: FileProgramSource,
      version: String,
      displayMethod: DisplayMethod,
      inputMethod: InputMethod
  ): Unit = {
    App.interpret(source, version: String, displayMethod, inputMethod)
  }
}

object App {
  private val lexer       = LexerImpl()
  private val parser      = ParserImpl()
  private val interpreter = InterpreterImpl()

  def main(args: Array[String]): Unit = {
    displayIntro(println)
    val version: String = displayVersionSelection(PrintScriptPrinter())
    val path: String    = displayPathOption(PrintScriptPrinter())
    val option: Int     = displayMenu(PrintScriptPrinter())

    if (option == 1) {
      try {
        interpret(FileProgramSource(path), version, PrintScriptPrinter(), PrintScriptInput())
      } catch {
        case e: ExpectedEndOfLineException =>
          println("ERROR\ncolumn: " + e.position + " line: " + e.line)
          println(e.getMessage)
        case e: ExpressionExpectedException =>
          println("ERROR\ncolumn: " + e.position + " line: " + e.line)
          println(e.getMessage)
        case e: Exception =>
          println(e.getMessage, e.toString)
      }
    }

    if (option == 2) {
      try {
        validate(FileProgramSource(path), version)
      } catch {
        case e: Exception =>
          println("Validation failed")
          println(e.getMessage, e.toString)
      }
    }
  }

  def interpret(
      source: FileProgramSource,
      version: String,
      displayMethod: DisplayMethod,
      inputMethod: InputMethod
  ): Unit = {
    lexer.setVersion(version)
    val tokens = lexer.lex(source)
    val ast    = parser.parse(source, tokens)
    interpreter.interpret(ast, displayMethod, inputMethod)
  }

  def validate(source: FileProgramSource, version: String): Unit = {
    lexer.setVersion(version)
    val tokens = lexer.lex(source)
    val ast    = parser.parse(source, tokens)
    interpreter.validate(ast)
  }

  def displayIntro(displayMethod: (String) => Unit): Unit = {
    displayMethod(" _____      _       _    _____           _       _   ")
    displayMethod("|  __ \\    (_)     | |  / ____|         (_)     | |  ")
    displayMethod("| |__) | __ _ _ __ | |_| (___   ___ _ __ _ _ __ | |_ ")
    displayMethod("|  ___/ '__| | '_ \\| __|\\___ \\ / __| '__| | '_ \\| __|")
    displayMethod("| |   | |  | | | | | |_ ____) | (__| |  | | |_) | |_ ")
    displayMethod("|_|   |_|  |_|_| |_|\\__|_____/ \\___|_|  |_| .__/ \\__|")
    displayMethod("                                          | |        ")
    displayMethod("                                          |_|        ")
    displayMethod("")
    displayMethod("_____________________________________________________")
    displayMethod("")
    displayMethod("")
  }

  def displayVersionSelection(displayMethod: DisplayMethod): String = {
    displayMethod.display("1.0 or 1.1?")
    displayMethod.display("")
    scala.io.StdIn.readLine()
  }

  def displayPathOption(displayMethod: DisplayMethod): String = {
    displayMethod.display("Path to file: ")
    displayMethod.display("")
    scala.io.StdIn.readLine()
  }

  def displayMenu(displayMethod: DisplayMethod): Int = {
    displayMethod.display("1. Interpret")
    displayMethod.display("2. Validate")
    displayMethod.display("")
    val option = scala.io.StdIn.readInt()
    if (option == 1 || option == 2) {
      option
    } else {
      displayMenu(displayMethod)
    }
  }

}
